<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>QualityControl: Modules development</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">QualityControl
   &#160;<span id="projectnumber">1.5.1</span>
   </div>
   <div id="projectbrief">O2 Data Quality Control Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_doc_ModulesDevelopment.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Modules development </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#modules-development">Modules development</a><ul>
<li><a href="#context">Context</a><ul>
<li><a href="#qc-architecture">QC architecture</a></li>
<li><a href="#dpl">DPL</a></li>
<li><a href="#data-sampling">Data Sampling</a><ul>
<li><a href="#custom-data-sampling-condition">Custom Data Sampling Condition</a></li>
<li><a href="#bypassing-the-data-sampling">Bypassing the Data Sampling</a></li>
</ul>
</li>
<li><a href="#code-organization">Code Organization</a></li>
<li><a href="#developing-with-alibuildalienv">Developing with aliBuild/alienv</a></li>
<li><a href="#user-defined-modules">User-defined modules</a></li>
<li><a href="#repository">Repository</a><ul>
<li><a href="#paths">Paths</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#module-creation">Module creation</a></li>
<li><a href="#test-run">Test run</a><ul>
<li><a href="#saving-the-qc-objects-in-a-local-file">Saving the QC objects in a local file</a></li>
</ul>
</li>
<li><a href="#modification-of-the-task">Modification of the Task</a></li>
<li><a href="#check">Check</a><ul>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#implementation">Implementation</a></li>
</ul>
</li>
<li><a href="#quality-aggregation">Quality Aggregation</a><ul>
<li><a href="#quick-try">Quick try</a></li>
<li><a href="#configuration-1">Configuration</a></li>
<li><a href="#implementation-1">Implementation</a></li>
</ul>
</li>
<li><a href="#committing-code">Committing code</a></li>
<li><a href="#data-sources">Data sources</a><ul>
<li><a href="#readout">Readout</a></li>
<li><a href="#dpl-workflow">DPL workflow</a></li>
</ul>
</li>
<li><a href="#a-more-advanced-example">A more advanced example</a></li>
</ul>
</li>
</ul>
<p>← Go back to Quickstart | ../README.md "↑ Go to the Table of Content ↑" | Continue to Post-processing →</p>
<h2>Context</h2>
<p>Before developing a module, one should have a bare idea of what the QualityControl is and how it is designed. The following sections explore these aspects.</p>
<h3>QC architecture</h3>
<div class="image">
<img src="images/Architecture.png"  alt="alt text"/>
</div>
<p>The main data flow is represented in blue. Data samples are selected by the Data Sampling (not represented) and sent to the QC tasks, either on the same machines or on other machines. The tasks produce TObjects, usually histograms, encapsulated in a MonitorObject that are merged (if needed) and then checked. The checkers output a QualityObject along with the MonitorObjects which might have been modified. The MonitorObjects and the QualityObjects are stored in the repository. The QualityObjects can also optionally be aggregated by the Aggregators to produce additional QualityObjects that are also saved in the database.</p>
<p>Asynchronously, the Post-processing can retrieve MonitorObjects from the database when certain events happen (new version of an object, new run) and produce new TObjects such as a trending plot.</p>
<h3>DPL</h3>
<p>https://github.com/AliceO2Group/AliceO2/blob/dev/Framework/Core/README.md "Data Processing Layer" is a software framework developed as a part of O2 project. It structurizes the computing into units called <em>Data Processors</em> - processes that communicate with each other via messages. DPL takes care of generating and running the processing topology out of user declaration code, serializing and deserializing messages, providing the data processors with all the anticipated messages for a given timestamp and much more. Each piece of data is characterized by its <code>DataHeader</code>, which consists (among others) of <code>dataOrigin</code>, <code>dataDescription</code> and <code>SubSpecification</code> - for example <code>{"MFT", "TRACKS", 0}</code>.</p>
<p>An example of a workflow definition which describes the processing steps (<em>Data Processors</em>), their inputs and their outputs can be seen in <a href="https://github.com/AliceO2Group/QualityControl/blob/master/Framework/src/runBasic.cxx">runBasic.cxx</a>. In the QC we define the workflows in files whose names are prefixed with <code>run</code>.</p>
<h3>Data Sampling</h3>
<p>The Data Sampling provides the possibility to sample data in DPL workflows, based on certain conditions ( 5% randomly, when payload is greater than 4234 bytes or others, including custom conditions). The job of passing the right data is done by a data processor called <code>Dispatcher</code>. A desired data stream is specified in the form of Data Sampling Policies, defined in the QC JSON configuration file. Please refer to the main <a href="https://github.com/AliceO2Group/AliceO2/blob/dev/Framework/Core/README.md#data-sampling">Data Sampling readme</a> for more details.</p>
<p>Data Sampling is used by Quality Control to feed the tasks with data. Below we present an example of a configuration file. It instructs Data Sampling to provide a QC task with 10% randomly selected data that has the header <code>{"ITS", "RAWDATA", 0}</code>. The data will be accessible inside the QC task by the binding <code>"raw"</code>. </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;qc&quot;: {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    ...</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    &quot;tasks&quot;: {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;      &quot;QcTask&quot;: {</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;        ...</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        &quot;dataSource&quot;: {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;          &quot;type&quot;: &quot;dataSamplingPolicy&quot;,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;          &quot;name&quot;: &quot;its-raw&quot;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        },</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        ...</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;      }</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    }</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;  },</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;  &quot;dataSamplingPolicies&quot;: [</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    {</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;      &quot;id&quot;: &quot;its-raw&quot;,</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;      &quot;active&quot;: &quot;true&quot;,</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;      &quot;machines&quot;: [],</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;      &quot;query_comment&quot; : &quot;query is in the format of binding1:origin1/description1/subSpec1[;binding2:...]&quot;,</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;      &quot;query&quot;: &quot;raw:ITS/RAWDATA/0&quot;,</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;      &quot;samplingConditions&quot;: [</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        {</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;          &quot;condition&quot;: &quot;random&quot;,</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;          &quot;fraction&quot;: &quot;0.1&quot;,</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;          &quot;seed&quot;: &quot;1234&quot;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        }</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;      ],</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;      &quot;blocking&quot;: &quot;false&quot;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    }</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  ]</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;}</div></div><!-- fragment --><p>An example of using the data sampling in a DPL workflow is visible in <a href="https://github.com/AliceO2Group/QualityControl/blob/master/Framework/src/runAdvanced.cxx">runAdvanced.cxx</a>.</p>
<h4>Custom Data Sampling Condition</h4>
<p>If needed, a custom data selection can be performed by inheriting the <code>DataSamplingCondition</code> class and implementing the <code>configure</code> and <code>decide</code> methods. Then, to use it, one needs to specify the library and class names in the config file.</p>
<p>The class <a href="https://github.com/AliceO2Group/QualityControl/blob/master/Modules/Example/include/Example/ExampleCondition.h">ExampleCondition</a> presents the how to write one's own condition, while in <a href="https://github.com/AliceO2Group/QualityControl/blob/master/Framework/example-default.json">example-default.json</a> the policy <code>ex1</code> shows how it should be configured.</p>
<h4>Bypassing the Data Sampling</h4>
<p>In case one needs to sample at a very high rate, or even monitor 100% of the data, the Data Sampling can be omitted altogether. As a result the task is connected directly to the the Device producing the data to be monitored. To do so, change the <em>dataSource's</em> type in the config file from <code>dataSamplingPolicy</code> to <code>direct</code>. In addition, add the information about the type of data that is expected (dataOrigin, binding, etc...) and remove the dataSamplingPolicies :</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;qc&quot;: {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    ...</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    &quot;tasks&quot;: {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;      &quot;QcTask&quot;: {</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;        ...</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        &quot;dataSource&quot;: {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;          &quot;type&quot;: &quot;direct&quot;,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;          &quot;query_comment&quot; : &quot;query is in the format of binding1:origin1/description1/subSpec1[;binding2:...]&quot;,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;          &quot;query&quot; : &quot;its-raw-data:ITS/RAWDATA/0&quot;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        },</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        ...</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;      }</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    }</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;  },</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;  &quot;dataSamplingPolicies&quot;: [</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  ]</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;}</div></div><!-- fragment --><p>The file <code>basic-no-sampling.json</code> is provided as an example. To test it, you can run <code>o2-qc</code> with that configuration file instead of <code>basic.json</code>.</p>
<p>To use multiple direct data sources, just place them one after another in the value of <code>"query"</code>, separated with a semicolon. For example: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&quot;query&quot; : &quot;emcal-digits:EMC/DIGITS/0;emcal-triggers:EMC/TRIGGERS/0&quot;</div></div><!-- fragment --><h3>Code Organization</h3>
<p>The repository QualityControl contains the <em>Framework</em> and the <em>Modules</em> in the respectively named directories.</p>
<p>The Data Sampling code is part of the AliceO2 repository.</p>
<h3>Developing with aliBuild/alienv</h3>
<p>One can of course build using <code>aliBuild</code> (<code>aliBuild build --defaults o2 QualityControl</code>). However, that will take quite some time as it checks all dependencies and builds everything.</p>
<p>After the initial use of <code>aliBuild</code>, which is necessary, the correct way of building is to load the environment with <code>alienv</code> and then go to the build directory and run <code>make</code> or <code>ninja</code>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;alienv load QualityControl/latest</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd sw/BUILD/QualityControl-latest/QualityControl</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;make -j8 install # or ninja -j8 install , also adapt to the number of cores available</div></div><!-- fragment --><p>If you need to use the QCG or Readout, load <code>O2Suite</code> instead of <code>QualityControl</code>.</p>
<h3>User-defined modules</h3>
<p>The Quality Control uses <em>plugins</em> to load the actual code to be executed by the <em>Tasks</em>, the <em>Checks</em>, the <em>Aggregators</em> and the <em>PostProcessing</em>. A module, or plugin, can contain one or several of these classes. They must subclass the corresponding interfaces, for example <code><a class="el" href="TaskInterface_8h.html">TaskInterface.h</a></code> or <code><a class="el" href="CheckInterface_8h.html">CheckInterface.h</a></code>. We use the Template Method Design Pattern.</p>
<p>The same code, the same class, can be run many times in parallel. It means that one can run several copies of the same qc Task in parallel, each executing the same code but on different data samples, typically on different nodes.</p>
<h3>Repository</h3>
<p>QC results (MonitorObjects and QualityObjects) are stored in a repository that we usually call the QCDB. Indeed, the underlying technology is the one of the CCDB (Condition and Calibration DataBase). As a matter of fact we use the test instance of the CCDB for the tests and development (ccdb-test.cern.ch:8080). In production, we will have a different instance distinct from the CCDB.</p>
<h4>Paths</h4>
<p>We use a consistent system of path for the objects we store in the QCDB:</p><ul>
<li>MonitorObjects: <code>qc/&lt;detectorCode&gt;/MO/&lt;taskName&gt;/&lt;moName&gt;</code></li>
<li>QualityObjects: <code>qc/&lt;detectorCode&gt;/QO/&lt;checkName&gt;[/&lt;moName&gt;]</code> The last, optional, part depends on the policy (read more about that <a href="#Check">later</a>).</li>
</ul>
<h2>Module creation</h2>
<p>Before starting to develop the code, one should create a new module if it does not exist yet. Typically each detector team should prepare a module.</p>
<p>The script <code>o2-qc-module-configurator.sh</code>, in the directory <em>Modules</em>, is able to prepare a new module or to add a new <em>Task</em>, <em>Check</em>, <em>Aggregator</em> or PostProcessing task to an existing module. It must be run from <b>within QualityControl/Modules</b>. See the help message below: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Usage: ./o2-qc-module-configurator.sh -m MODULE_NAME [OPTION]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;Generate template QC module and/or tasks, checks, aggregators and postprocessing.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;If a module with specified name already exists, new tasks, checks, aggregators and postprocessing are inserted to the existing module.</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Please follow UpperCamelCase convention for modules&#39;, tasks&#39; and checks&#39; names.</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;Example:</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;# create new module and some task</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;./o2-qc-module-configurator.sh -m MyModule -t SuperTask</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;# add one task and two checks</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;./o2-qc-module-configurator.sh -m MyModule -t EvenBetterTask -c HistoUniformityCheck -c MeanTest</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;Options:</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; -h               print this message</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160; -m MODULE_NAME   create a module named MODULE_NAME or add there some task/checker</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; -t TASK_NAME     create a task named TASK_NAME</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160; -c CHECK_NAME    create a check named CHECK_NAME</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160; -p PP_NAME       create a postprocessing task named PP_NAME</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; -a AGG_NAME      create an aggregator named AGG_NAME</div></div><!-- fragment --><p>For example, if your detector 3-letter code is TST you might want to do </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# we are in ~/alice</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd QualityControl/Modules</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;./o2-qc-module-configurator.sh -m TST -t RawDataQcTask # create the module and a task</div></div><!-- fragment --><p>IMPORTANT: Make sure that your detector code is listed in TaskRunner::validateDetectorName. If it is not, feel free to add it.</p>
<p>We will refer in the following section to the module as <code>Tst</code> and the task as <code>RawDataQcTask</code>. Make sure to use your own code and names.</p>
<h2>Test run</h2>
<p>Now that there is a module, we can build it and test it. First let's build it : </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# We are in ~/alice, call alienv if not already done</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;alienv enter QualityControl/latest</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;# Go to the build directory of QualityControl.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;cd sw/BUILD/QualityControl-latest/QualityControl</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;make -j8 install # or ninja, replace 8 by the number of cores on your machine</div></div><!-- fragment --><p>To test whether it works, we are going to run a basic workflow made of a producer and the qc, which corresponds to the one we saw in the <a href="QuickStart.md#basic-workflow">QuickStart</a>.</p>
<p>We are going to duplicate the config file we used previously, i.e. <code>basic.json</code>: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cp ~/alice/QualityControl/Framework/basic.json ~/alice/QualityControl/Modules/TST/basic-tst.json</div></div><!-- fragment --><p>We need to modify it slightly to indicate our freshly created module and classes. Change the lines as indicated below :</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&quot;tasks&quot;: {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;MyRawDataQcTask&quot;: {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    &quot;active&quot;: &quot;true&quot;,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    &quot;className&quot;: &quot;o2::quality_control_modules::abc::RawDataQcTask&quot;,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    &quot;moduleName&quot;: &quot;QcTST&quot;,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    &quot;detectorName&quot;: &quot;TST&quot;,</div></div><!-- fragment --><p> and </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&quot;detectorName&quot;: &quot;TST&quot;,</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;&quot;dataSource&quot;: [{</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &quot;type&quot;: &quot;Task&quot;,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  &quot;name&quot;: &quot;MyRawDataQcTask&quot;,</div></div><!-- fragment --><p>Now we can run it</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-qc-run-producer | o2-qc --config json://$HOME/alice/QualityControl/Modules/TST/basic-tst.json</div></div><!-- fragment --><p>You should see an object <code>example</code> in <code>/qc/TST/MO/MyRawDataQcTask</code> at qcg-test.cern.ch.</p>
<h3>Saving the QC objects in a local file</h3>
<p>When debugging and developping, and only in this case, it can be handy to save the objects being produced to a file. Simply add the parameter <code>saveObjectsToFile</code> to the task definition and set it to file name with or without a path. For example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&quot;saveObjectsToFile&quot;: &quot;test.root&quot;,      &quot;&quot;: &quot;For debugging, path to the file where to save. If empty it won&#39;t save.&quot;</div></div><!-- fragment --><h2>Modification of the Task</h2>
<p>We are going to modify our task to make it publish a second histogram. Objects must be published only once and they will then be updated automatically every cycle (10 seconds for our example, 1 minute in general). Modify <code>RawDataQcTask.cxx</code> and its header to add a new histogram, build it and publish it with <code>getObjectsManager()-&gt;startPublishing(mHistogram);</code>. Once done, recompile it (see section above, <code>make -j8 install</code> in the build directory) and run it (same as above). You should see the second object published in the qcg.</p>
<h2>Check</h2>
<p>A Check is a function that determines the quality of the Monitor Objects produced in the previous step - Task. It can receive multiple Monitor Objects from several Tasks.</p>
<h3>Configuration</h3>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;qc&quot; : {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    &quot;config&quot; : { ... },</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    &quot;tasks&quot; : { ... },</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    &quot;checks&quot;: {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;      &quot;CheckName&quot;: {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        &quot;active&quot;: &quot;true&quot;,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        &quot;className&quot;: &quot;o2::quality_control_modules::skeleton::SkeletonCheck&quot;,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        &quot;moduleName&quot;: &quot;QcSkeleton&quot;,</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        &quot;policy&quot;: &quot;OnAny&quot;,</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        &quot;dataSource&quot;: [{</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;          &quot;type&quot;: &quot;Task&quot;,</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;          &quot;name&quot;: &quot;TaskName&quot;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        },</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        {</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;          &quot;type&quot;: &quot;Task&quot;,</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;          &quot;name&quot;: &quot;QcTask&quot;,</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;          &quot;MOs&quot;: [&quot;example&quot;, &quot;other&quot;]</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;        }]</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;      },</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;      &quot;QcCheck&quot;: {</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;         ...</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;      }</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;   }</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;}</div></div><!-- fragment --><ul>
<li><b>active</b> - Boolean to indicate whether the checker is active or not</li>
<li><b>moduleName</b> - Name of the module which implements the check class (like in tasks)</li>
<li><b>className</b> - Name and namespace of the class, which is part of the module specified above (like in tasks)</li>
<li><b>policy</b> - Policy for triggering the <em>check</em> function defined in the class:<ul>
<li><em>OnAny</em> (default) - Triggers if ANY of the listed monitor objects changes.</li>
<li><em>OnAnyNonZero</em> - Triggers if ANY of the declared monitor objects changes, but only after all listed objects have been received at least once.</li>
<li><em>OnAll</em> - Triggers if ALL the listed monitor objects have changed.</li>
<li><em>OnEachSeparately</em> - Triggers separately for EACH of the listed objects whenever one of them changes.</li>
<li>In case the list of monitor objects is empty, the policy is simply ignored and the <code>check</code> will be triggered whenever a new MonitorObject is received.</li>
</ul>
</li>
<li><b>dataSource</b> - declaration of the <code>check</code> input<ul>
<li><em>type</em> - currently only supported is <em>Task</em></li>
<li><em>name</em> - name of the <em>Task</em></li>
<li><em>MOs</em> - list of MonitorObjects names or can be omitted to mean that all objects should be taken.</li>
</ul>
</li>
</ul>
<h3>Implementation</h3>
<p>After the creation of the module described in the above section, every Check functionality requires a separate implementation. The module might implement several Check classes. </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;Quality check(std::map&lt;std::string, std::shared_ptr&lt;MonitorObject&gt;&gt;* moMap) {}</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;void beautify(std::shared_ptr&lt;MonitorObject&gt; mo, Quality = Quality::Null) {}</div></div><!-- fragment --><p>The <code>check</code> function is called whenever the <em>policy</em> is satisfied. It gets a map with all declared MonitorObjects. It is expected to return Quality of the given MonitorObjects.</p>
<p>The <code>beautify</code> function is called after the <code>check</code> function if there is a single <code>dataSource</code> of type <code>Task</code> in the configuration of the check. If there is more than one, the <code>beautify()</code> is not called in this check.</p>
<h2>Quality Aggregation</h2>
<p>The <em>Aggregators</em> are able to collect the QualityObjects produced by the checks or other <em>Aggregators</em> and to produce new Qualities. This is especially useful to determine the overall quality of a detector or a set of detectors.</p>
<div class="image">
<img src="images/Aggregation.png"  alt="alt text"/>
</div>
<h3>Quick try</h3>
<p>One can try it with this simple example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;o2-qc-run-basic --config-path ${QUALITYCONTROL_ROOT}/etc/basic-aggregator.json</div></div><!-- fragment --><p>Notice the AggregatorRunner after the CheckRunner.</p>
<p>A more complex example with a producer and the <code>o2-qc</code>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-qc-run-advanced --no-qc | o2-qc --config json://${QUALITYCONTROL_ROOT}/etc/advanced-aggregator.json</div></div><!-- fragment --><h3>Configuration</h3>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;qc&quot;: {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    &quot;config&quot;: {...},</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    &quot;tasks&quot;: {...},</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    &quot;checks&quot;: {...},</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    &quot;aggregators&quot;: {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;      &quot;MyAggregator&quot;: {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        &quot;active&quot;: &quot;true&quot;,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        &quot;className&quot;: &quot;o2::quality_control_modules::skeleton::SkeletonAggregator&quot;,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        &quot;moduleName&quot;: &quot;QcSkeleton&quot;,</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        &quot;policy&quot;: &quot;OnAll&quot;,</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        &quot;detectorName&quot;: &quot;TST&quot;,</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;        &quot;dataSource&quot;: [{</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;          &quot;type&quot;: &quot;Check&quot;,</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;          &quot;name&quot;: &quot;QcCheck&quot;, &quot;&quot;: &quot;If the check produces multiple objects, specify \&quot;QOs\&quot;&quot;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        }, </div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        {</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;          &quot;type&quot;: &quot;Aggregator&quot;,</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;          &quot;name&quot;: &quot;MyOtherAggregator&quot;,</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;          &quot;QOs&quot;: [&quot;newQuality&quot;, &quot;another&quot;]</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        }]</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;      }</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    }</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  },</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  &quot;dataSamplingPolicies&quot;: [...]</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;}</div></div><!-- fragment --><ul>
<li><b>active</b> - Boolean to indicate whether the aggregator is active or not</li>
<li><b>moduleName</b> - Name of the module which implements the aggregator class (like in tasks)</li>
<li><b>className</b> - Name and namespace of the class, which is part of the module specified above (like in tasks)</li>
<li><b>policy</b> - Policy for triggering the <em>check</em> function defined in the class:<ul>
<li><em>OnAny</em> (default) - Triggers if ANY of the listed quality objects changes.</li>
<li><em>OnAll</em> - Triggers if ALL the listed quality objects have changed.</li>
<li>In case the list of QualityObject is empty, the policy is simply ignored and the <code>check</code> will be triggered whenever a new QualityObject is received.</li>
</ul>
</li>
<li><b>dataSource</b> - declaration of the <code>check</code> input<ul>
<li><em>type</em> - <em>Check</em> or <em>Aggregator</em></li>
<li><em>names</em> - name of the Check or Aggregator</li>
<li><em>QOs</em> - list of QualityObjects names or can be omitted to mean that all objects should be taken.</li>
</ul>
</li>
</ul>
<h3>Implementation</h3>
<p>With <code>o2-qc-module-configurator.sh</code> (see <a href="#module-creation">here</a>), create a new Aggregator that can be then used in the config file.</p>
<p>An aggregator inherits from <code>AggregatorInterface</code> and in particular this method: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  virtual std::vector&lt;Quality&gt; aggregate(std::map&lt;std::string, std::shared_ptr&lt;const o2::quality_control::core::QualityObject&gt;&gt;&amp; qoMap) = 0;</div></div><!-- fragment --><p>The <code>aggregate</code> method is called whenever the <em>policy</em> is satisfied. It gets a map with all the declared QualityObjects. It is expected to return a new Quality based on the inputs.</p>
<h2>Committing code</h2>
<p>To commit your new or modified code, please follow this procedure</p><ol type="1">
<li>Fork the <a href="github.com/AliceO2Group/QualityControl">QualityControl</a> repo using github webpage or github desktop app.</li>
</ol>
<ol type="1">
<li>Clone it : <code>git clone <a href="https://github.com/">https://github.com/</a>&lt;yourIdentifier&gt;/QualityControl.git</code></li>
</ol>
<ol type="1">
<li>Before you start working on your code, create a branch in your fork : <code>git checkout -b feature-new-stuff</code></li>
<li>Push the branch : <code>git push --set-upstream origin feature-new-stuff</code></li>
</ol>
<ol type="1">
<li>Add and commit your changes onto this branch : <code>git add Abc.cxx ; git commit Abc.cxx</code></li>
<li>Push your commits : <code>git push</code></li>
<li>Once you are satisfied with your changes, make a <em>Pull Request</em> (PR). Go to your branches on the github webpage, and click "New Pull Request". Explain what you did. If you only wanted to share the progress, but your PR is not ready for a review yet, please put <b>[WIP]</b> (Work In Progress) in the beginning of its name.</li>
<li>One of the QC developers will check your code. It will also be automatically tested.</li>
<li>Once approved the changes will be merged in the main repo. You can delete your branch.</li>
</ol>
<p>For a new feature, just create a new branch for it and use the same procedure. Do not fork again. You can work on several features at the same time by having parallel branches.</p>
<p>General ALICE Git guidelines can be accessed <a href="https://alisw.github.io/git-tutorial/">here</a>.</p>
<h2>Data sources</h2>
<p>In the final system, the qc gets real data from the DPL devices or the readout processes. During development a number of possibilities are available for the detector teams to develop their QC. We list them below.</p>
<h3>Readout</h3>
<p>When connecting the QC directly to the readout using the <code>o2-qc-run-readout</code> proxy, remember to add this consumer to the config file of the readout and to enable it: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[consumer-fmq-qc]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;consumerType=FairMQChannel</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;enableRawFormat=1</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;fmq-name=readout-qc</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;fmq-address=ipc:///tmp/readout-pipe-1</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;fmq-type=pub</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;fmq-transport=zeromq</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;unmanagedMemorySize=2G</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;memoryPoolNumberOfPages=500</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;memoryPoolPageSize=1M</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;enabled=1</div></div><!-- fragment --><p><b>Random data</b></p>
<p>Add one or several dummy equipments: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[equipment-dummy-1]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;name=dummy-1</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;equipmentType=dummy</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;enabled=1</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;eventMaxSize=200</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;eventMinSize=100</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;memoryPoolNumberOfPages=100</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;memoryPoolPageSize=128k</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;fillData=1</div></div><!-- fragment --><p><b>Live detector data</b></p>
<p>If a part or the whole detector is ready and connected to 1 or several CRUs in the FLP, configure the readout to get data from there. The exact configuration items should be discussed with the readout experts.</p>
<p>This is the most realistic test one can do but it is also not very practical as you have to control the data taking and be on the machine equipped with a CRU. See the next section to alleviate this situation.</p>
<p><b>Detector data file</b></p>
<p>To record a data file with readout while getting data from a CRU, add the following piece to the readout configuration file: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[consumer-rec]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;enabled=1</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;consumerType=fileRecorder</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;fileName=/tmp/dataRecorder_flp1.raw</div></div><!-- fragment --><p>To read it back with readout, for instance on another machine, add: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[equipment-player-1]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;equipmentType=player</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;memoryPoolPageSize=1M</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;memoryPoolNumberOfPages=1000</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;filePath=/path/to/dataRecorder_flp1.raw </div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;autoChunk=1</div></div><!-- fragment --><h3>DPL workflow</h3>
<p>When plugging the QC on a DPL workflow to monitor the output of one or several devices, one should of course have some data producer in the workflow itself. Several options exist, listed below.</p>
<p><b>Random data</b></p>
<p>As shown earlier in this documentation we provide a random data generator. The binary is called <code>o2-qc-run-producer</code> and many options are available (use <code>--help</code> to see them).</p>
<p><b>Data file</b></p>
<p>To write and read data files in the DPL, please refer to the <a href="https://github.com/AliceO2Group/AliceO2/tree/dev/Detectors/Raw#rawfilewriter">RawFileWriter</a> and <a href="https://github.com/AliceO2Group/AliceO2/tree/dev/Detectors/Raw#rawfilereader">RawFileReader</a>.</p>
<p>On the same page, there are instructions to write such file from Simulation.</p>
<p>Another option to read a raw data file, produced by Simulation or recorded with <code>readout.exe</code> per instance, is to use directly the program <code>o2-raw-file-reader-workflow</code> in O2 as described <a href="https://github.com/AliceO2Group/AliceO2/tree/dev/Detectors/Raw#raw-data-file-reader-workflow">here</a> (the config file is described <a href="https://github.com/AliceO2Group/AliceO2/tree/dev/Detectors/Raw#rawfilereader">earlier in the page</a>). </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-raw-file-reader-workflow --conf myConf.cfg | o2-qc --config json://${QUALITYCONTROL_ROOT}/etc/readout.json</div></div><!-- fragment --><p><b>Live detector data</b></p>
<p>If the detector is ready and connected to the CRU(s), one can of course start the full data taking workflow, including the SubTimeFrameBuilder and the DPL processing and plug the QC onto it.</p>
<h2>A more advanced example</h2>
<p>A more complete example is available. The config file is called <a href="../Framework/advanced.json">advanced.json</a>. The workflow is made of 3 sources, intermediate processing steps, 3 sinks and a Dispatcher connecting two QC tasks to a number of these steps and 2 checks. The topology doesn't mean to represent any particular physics processing, it is just an example with multiple data processors.</p>
<div class="image">
<img src="images/advanced.png"  alt="alt text"/>
</div>
<p>To run it do either </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-qc-run-advanced</div></div><!-- fragment --><p> or </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-qc-run-advanced --no-qc | o2-qc --config json://${QUALITYCONTROL_ROOT}/etc/advanced.json</div></div><!-- fragment --> <hr/>
<p>← Go back to Quickstart | ../README.md "↑ Go to the Table of Content ↑" | Continue to Post-processing → </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
