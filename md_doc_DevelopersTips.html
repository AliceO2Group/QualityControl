<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>QualityControl: Developers&#39; tips</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">QualityControl
   &#160;<span id="projectnumber">1.5.1</span>
   </div>
   <div id="projectbrief">O2 Data Quality Control Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_doc_DevelopersTips.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Developers' tips </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a resource meant for the developers of the QC. Whenever we learn something useful we put it here. It is not sanitized or organized. Just a brain dump.</p>
<h3>Release procedure / check list</h3>
<ol type="1">
<li>Update the version number in <a href="../CMakeLists.txt">CMakeLists.txt</a>, commit and push</li>
<li>Release in JIRA</li>
</ol>
<ol type="1">
<li>Prepare the release notes using the commits since the last release in github (see this template).</li>
<li>Release in github, paste the release notes</li>
<li>A PR is automatically created in alidist</li>
<li>Once merged, send an email to <a href="#" onclick="location.href='mai'+'lto:'+'ali'+'ce'+'-o2'+'-w'+'p7@'+'ce'+'rn.'+'ch'; return false;">alice<span style="display: none;">.nosp@m.</span>-o2-<span style="display: none;">.nosp@m.</span>wp7@c<span style="display: none;">.nosp@m.</span>ern.<span style="display: none;">.nosp@m.</span>ch</a>, <a href="#" onclick="location.href='mai'+'lto:'+'ali'+'ce'+'-o2'+'-q'+'c-c'+'on'+'tac'+'t@'+'cer'+'n.'+'ch'; return false;">alice<span style="display: none;">.nosp@m.</span>-o2-<span style="display: none;">.nosp@m.</span>qc-co<span style="display: none;">.nosp@m.</span>ntac<span style="display: none;">.nosp@m.</span>t@cer<span style="display: none;">.nosp@m.</span>n.ch</a> and <a href="#" onclick="location.href='mai'+'lto:'+'ali'+'ce'+'-dp'+'g-'+'qa-'+'to'+'ols'+'@c'+'ern'+'.c'+'h'; return false;">alice<span style="display: none;">.nosp@m.</span>-dpg<span style="display: none;">.nosp@m.</span>-qa-t<span style="display: none;">.nosp@m.</span>ools<span style="display: none;">.nosp@m.</span>@cern<span style="display: none;">.nosp@m.</span>.ch</a> to announce the new release. Use the email for the previous release as a template.</li>
</ol>
<h3>Create a fix version</h3>
<ol type="1">
<li>checkout last tagged version, e.g. <code>git checkout v0.26.1</code></li>
<li>branch, e.g. <code>git checkout -b branch_v0.26.2</code></li>
</ol>
<ol type="1">
<li>cherry-pick the commit from master, e.g. <code>git cherry-pick b187ddbe52058d53a9bbf3cbdd53121c6b936cd8</code></li>
</ol>
<ol type="1">
<li>push the branch upstream, e.g. <code>git push upstream -u branch_v0.26.2</code></li>
<li>change version in CMakeLists and commit</li>
<li>tag, e.g. <code>git tag -a v0.26.2 -m "v0.26.2"</code></li>
</ol>
<ol type="1">
<li>push the tag upstream, e.g. <code>git push upstream v0.26.2</code></li>
<li>Release in github using this tag</li>
</ol>
<ol type="1">
<li>A PR is automatically created in alidist</li>
</ol>
<h3>Where and how to configure the repo_cleaner of the ccdb-test</h3>
<p>The config file is stored in git in the branch <code>repo_cleaner</code> (careful not to update in master instead !). Check out the branch, update the file Framework/script/RepoCleaner/config.yaml and commit it. A PR is necessary but in case of emergency, force-merge it. As soon as it is merged, it will be used by the script.</p>
<p>The config file used to be in <code>aldaqci@aidrefflp01:~/alice-ccdb/config.yaml</code> but it is not the case any more.</p>
<p>The different cleaning policies available at the moment are: 1_per_hour, 1_per_run, last_only, none_kept, skip</p>
<p>The repo_cleaner is launched every 5 minutes by <a href="https://alijenkins.cern.ch/job/FLP/job/CCDB%20Clean%20up/">Jenkins</a>.</p>
<p>Documentation of the repo_cleaner can be found ../Framework/script/RepoCleaner/README.md "here".</p>
<h3>Trick used to load old data</h3>
<p>Until version 3 of the class MonitorObject, objects were stored in the repository directly. They are now stored within TFiles. The issue with the former way is that the StreamerInfo are lost. To be able to load old data, the StreamerInfos have been saved in a root file "streamerinfos.root". The CcdbDatabase access class loads this file and the StreamerInfos upon creation which allows for a smooth reading of the old objects. The day we are certain nobody will add objects in the old format and that the old objects have been removed from the database, we can delete this file and remove the loading from CcdbDatabase. Moreover, the following lines can be removed : </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;// We could not open a TFile we should now try to open an object directly serialized</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;object = ccdbApi.retrieve(path, metadata, getCurrentTimestamp());</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;cout &lt;&lt; &quot;We could retrieve the object &quot; &lt;&lt; path &lt;&lt; &quot; as a streamed object.&quot; &lt;&lt; endl;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;if(object == nullptr) {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  return nullptr;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;}</div></div><!-- fragment --><h3>Doxygen generation</h3>
<p>To generate locally the doxygen doc, do <code>cd sw/BUILD/QualityControl-latest/QualityControl; make doc</code>. It will be available in doc/html, thus to open it quickly do <code>[xdg-]open doc/html/index.html</code>.</p>
<h3>Monitoring debug</h3>
<p>When we don't see the monitoring data in grafana, here is what to do to pinpoint the source of the problem.</p>
<ol type="1">
<li><code>ssh root@aido2mon-gpn.cern.ch</code></li>
<li>See if the data reach the servers :<ol type="a">
<li><code>systemctl stop influxdb</code></li>
<li><code>nc -u -l 8087</code> &lt;&ndash; make sure to use the proper port (cf your monitoring url)</li>
<li>The metrics should appear in clear in the terminal as they arrive. If not, check the monitoring url in your code/config.</li>
<li>systemctl start influxdb</li>
</ol>
</li>
<li>If they arrive, we want to check whether the metrics are stored<ol type="a">
<li>emacs /etc/influxdb/influxdb.conf<ol type="i">
<li>Search for the port you are using</li>
<li>Note the name of the database (for 8087 it is "qc")</li>
</ol>
</li>
<li><code>influx</code></li>
</ol>
<ol type="a">
<li><code>show databases</code></li>
<li><code>use qc</code> &lt;&ndash; use the proper database as found in influxdb.conf</li>
<li><code>show series</code></li>
<li><code>select count(*) from cpuUsedPercentage</code> &lt;&ndash; use the correct metrics name</li>
<li>Repeat the last command and see if the number increases. If it increases it denotes that the metrics is stored correctly in the database. If it is the case, the problem lies in your grafana.</li>
</ol>
</li>
</ol>
<h3>Monitoring setup for building the grafana dashboard</h3>
<ol type="1">
<li>Ask Adam for an account on pcald03.cern.ch:3000.</li>
<li>Ask Adam for a copy of the QC dashboard that you can edit.</li>
</ol>
<ol type="1">
<li>Set the monitoring url to <code>"url": "influxdb-udp://flptest2.cern.ch:8089"</code></li>
<li>Once the dashboard is ready, tell Adam.</li>
</ol>
<h3>Avoid writing QC objects to a repository</h3>
<p>In case of a need to avoid writing QC objects to a repository, one can choose the "Dummy" database implementation in the config file. This is might be useful when one expects very large amounts of data that would be stored, but not actually needed (e.g. benchmarks).</p>
<h3>QCG</h3>
<h4>Generalities</h4>
<p>The QCG server for qcg-test.cern.ch is hosted on qcg-qcg. The config file is <code>/home/qcg/QualityControlGui/config.js</code>.</p>
<h4>Access rights</h4>
<p>Any one in alice-member has access. We use the egroup alice-o2-qcg-access to grant access or not and this egroup contains alice-member plus a few extra. This allows for non ALICE members to access the QCG.</p>
<h4>Start and stop</h4>
<p><code>systemctl restart qcg</code></p>
<h3>Logging</h3>
<p>We use the infologger. There is a utility class, <code>QcInfoLogger</code>, that can be used. It is a singleton. See <a href="../Framework/include/QualityControl/QcInfoLogger.h">the header</a> for its usage.</p>
<p>Related issues : <a href="https://alice.its.cern.ch/jira/browse/QC-224">https://alice.its.cern.ch/jira/browse/QC-224</a></p>
<h3>Service Discovery (Online mode)</h3>
<p>Service discovery (Online mode) is used to list currently published objects by running QC tasks and checkers. It uses Consul to store:</p><ul>
<li>List of running QC tasks that respond to health check, known as "services" in Consul</li>
<li>List of published object by each QC task ("service"), knows as "tags" of a "service" in Consul</li>
<li>List of published Quality Objects by each CheckRunner.</li>
</ul>
<p>Both lists are updated from within QC task using <a href="#Service-Discovery-C++-API-and-Consul-HTTP-API">Service Discovery C++ API</a>:</p><ul>
<li><code>register</code> - when a tasks starts</li>
<li><code>deregister</code> - when tasks ends</li>
</ul>
<p>If the "health check" is failing, make sure the ports 7777 (Tasks) and 7778 (CheckRuners) are open.</p>
<h4>Register (and health check)</h4>
<p>When a QC task starts, it register its presence in Consul by calling <a href="https://www.consul.io/api/agent/service.html#register-service">register endpoit of Consul HTTP API</a>. The request needs the following fields:</p><ul>
<li><code>Id</code> - Task ID (must be unique)</li>
<li><code>Name</code> - Task name, tasks can have same name when they run on mutiple machines</li>
<li><code>Tags</code> - List of published objects</li>
<li><code>Checks</code> - Array of health check details for Consul, each should contain <code>Name</code>, <code>Interval</code>, type of check with endpoint to be check by Consul (eg. <code>"TCP": "localhost:1234"</code>) and <code>DeregisterCriticalServiceAfter</code> that defines timeout to automatically deregister service when fails health checks (minimum value <code>1m</code>).</li>
</ul>
<h4>Deregister</h4>
<p>In order to deregister a service <a href="https://www.consul.io/api/agent/service.html#deregister-service"><code>deregister/:Id</code> endpoint of Consul HTTP API</a> needs to be called. It does not need any additional parameters.</p>
<h3>QCG and QC integration tests</h3>
<p>What are the QC integration tests in the FLP Pipeline doing?</p>
<ul>
<li>They pretend to be one of us when doing a test for an FLP release.</li>
<li>Start a QC environment</li>
<li>Opening QCG and check existence of certain objects in offline &amp; online mode and that when you click on them they open a plot</li>
<li>Stop/Destroy that env</li>
</ul>
<p>Those object names are configurable from Ansible so that we do not have to release a new QCG rpm if we need to update the objects we check. So, if you know something will change modify the following file: <a href="https://gitlab.cern.ch/AliceO2Group/system-configuration/-/blob/dev/ansible/roles/flp-deployment-checks/templates/qcg-test-config.js.j2">https://gitlab.cern.ch/AliceO2Group/system-configuration/-/blob/dev/ansible/roles/flp-deployment-checks/templates/qcg-test-config.js.j2</a></p>
<p>If this test fail and one wants to investigate, they should first resume the VM in openstack. Then the normal web interfaces are available.</p>
<h3>Check the logs of the QCG</h3>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;journalctl -u o2-qcg</div></div><!-- fragment --><h3>Deploy a modified version of the ansible recipes</h3>
<p>When working on the ansible recipes and deploying with o2-flp-setup, the recipes to modify are in <code>.local/share/o2-flp-setup/system-configuration/</code>.</p>
<h3>Test with STFBuilder</h3>
<p><a href="https://alice.its.cern.ch/jira/browse/O2-169">https://alice.its.cern.ch/jira/browse/O2-169</a> </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;readout.exe file:///afs/cern.ch/user/b/bvonhall/dev/alice/sw/slc7_x86-64/DataDistribution/latest/config/readout_emu.cfg</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;StfBuilder \</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    --id stf_builder-0 \</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    --transport shmem \</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    --detector TPC \</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    --dpl-channel-name=dpl-chan \</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    --channel-config &quot;name=dpl-chan,type=push,method=bind,address=ipc:///tmp/stf-builder-dpl-pipe-0,transport=shmem,rateLogging=1&quot; \</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    --channel-config &quot;name=readout,type=pull,method=connect,address=ipc:///tmp/readout-pipe-0,transport=shmem,rateLogging=1&quot;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        --detector-rdh=4</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;o2-dpl-raw-proxy \</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;      -b \</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;      --session default \</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;      --dataspec &quot;B:TPC/RAWDATA&quot; \</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;      --channel-config &quot;name=readout-proxy,type=pull,method=connect,address=ipc:///tmp/stf-builder-dpl-pipe-0,transport=shmem,rateLogging=1&quot; \</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160; | o2-qc \</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;      --config json://$PWD/datadistribution.json \</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;      -b \</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;      --session default</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
