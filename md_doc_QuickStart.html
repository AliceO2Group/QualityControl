<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>QualityControl: QuickStart</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">QualityControl
   &#160;<span id="projectnumber">1.5.1</span>
   </div>
   <div id="projectbrief">O2 Data Quality Control Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_doc_QuickStart.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">QuickStart </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#quickstart">QuickStart</a><ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#setup">Setup</a><ul>
<li><a href="#environment-loading">Environment loading</a></li>
</ul>
</li>
<li><a href="#execution">Execution</a><ul>
<li><a href="#basic-workflow">Basic workflow</a></li>
<li><a href="#readout-chain">Readout chain</a><ul>
<li><a href="#getting-real-data-from-readout">Getting real data from readout</a></li>
<li><a href="#readout-data-format-as-received-by-the-task">Readout data format as received by the Task</a></li>
</ul>
</li>
<li><a href="#post-processing-example">Post-processing example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>../README.md "↑ Go to the Table of Content ↑" | Continue to Modules Development →</p>
<h2>Read this first!</h2>
<p>This page will give you a basic idea of the QC and how to run it. Please read it <em>in its entirety</em> and run the commands along the way. Do not start developing your module before you have reached the next section called "Modules Development". Also, make sure you have pulled the latest QC version.</p>
<p>We would be very grateful if you could report to us any error or inaccuracy you found.</p>
<p>Thanks!</p>
<h2>Requirements</h2>
<p>A CC7 machine (Mac, and in particular Ubuntu, are only supported on a best effort basis, some packages might not build properly).</p>
<h2>Setup</h2>
<ol type="1">
<li>Setup O2 environment and tools <br />
We use alibuild, see complete instructions <a href="https://alice-doc.github.io/alice-analysis-tutorial/building/">here</a> (prefer the second option, not alidock). In particular make sure to follow these steps:<ol type="a">
<li>Install GLFW to have GUIs in the DPL (optional, <b>DPL GUIs do not work in containers nor over SSH</b>).<ul>
<li>CC7: <code>sudo yum install -y glfw-devel --enablerepo=epel</code></li>
<li>Mac: <code>brew install glfw</code></li>
</ul>
</li>
<li>Prerequisites<ul>
<li><a href="https://alice-doc.github.io/alice-analysis-tutorial/building/prereq-centos7.html">CC7</a></li>
<li><a href="https://alice-doc.github.io/alice-analysis-tutorial/building/prereq-macos.html">Mac</a> (best effort)</li>
<li><a href="https://alice-doc.github.io/alice-analysis-tutorial/building/prereq-ubuntu.html">Ubuntu</a> (best effort)</li>
</ul>
</li>
<li><a href="https://alice-doc.github.io/alice-analysis-tutorial/building/custom.html#get-or-upgrade-alibuild">Install aliBuild</a></li>
<li><a href="https://alice-doc.github.io/alice-analysis-tutorial/building/build.html">Check setup and build O2</a></li>
</ol>
</li>
<li>Prepare the QualityControl development package<ul>
<li><code>aliBuild init QualityControl@master --defaults o2</code></li>
</ul>
</li>
<li>Build/install the QualityControl, its GUI (qcg) and the readout. The simplest is to use the metapackage <code>O2Suite</code>.<ul>
<li><code>aliBuild build O2Suite --defaults o2</code></li>
<li>At this point you might encounter a message about missing system requirements. Run <code>aliDoctor O2Suite</code> to get a full information about what is missing and how to install it.</li>
</ul>
</li>
</ol>
<p>Note: on non-CC7 systems, you can also use the alibuild "defaults" called <code>o2-dataflow</code> to avoid building simulation related packages. Moreover, you can build <code>qcg</code> instead of <code>O2Suite</code> if you don't plan to use the readout (remember to substitute <code>O2Suite</code> with <code>qcg</code> when loading the environment).</p>
<h3>Environment loading</h3>
<p>Whenever you want to work with O2 and QualityControl, do either <code>alienv enter O2Suite/latest</code> or <code>alienv load O2Suite/latest</code>.</p>
<p>You can also load a package instead of the whole O2Suite, i.e. <code>alienv enter QualityControl/latest</code> or <code>alienv enter qcg/latest</code>.</p>
<h2>Execution</h2>
<p>To make sure that your system is correctly setup, we are going to run a basic QC workflow attached to a simple data producer. We will use central services for the repository and the GUI. If you want to set them up on your computer or in your lab, please have a look <a href="#local-ccdb-setup">here</a> and <a href="#local-qcg-setup">here</a>.</p>
<h3>Basic workflow</h3>
<p>We are going to run a basic workflow whose various processes are shown in the following schema.</p>
<div class="image">
<img src="images/basic-schema.png"  alt="basic-schema"/>
</div>
<p>The <em>Producer</em> is a random data generator. In a more realistic setup it would be a processing device or the <em>Readout</em>. The <em>Data Sampling</em> is the system in charge of dispatching data samples from the main data flow to the <em>QC tasks</em>. It can be configured to dispatch different proportion or different types of data. The <b>tasks</b> are in charge of analyzing the data and preparing QC objects, often histograms, that are then pushed forward every cycle. A cycle is 10 second in this example. In production it is closer to 1 minute. The <em>Checker</em> is in charge of evaluating the <em>MonitorObjects</em> produced by the <em>QC tasks</em>. It runs <em>Checks</em> defined by the users, for example checking that the mean is above a certain limit. It can also modify the aspect of the histogram, e.g. by changing the background color or adding a PaveText. Finally the <em>Checker</em> is also in charge of storing the resulting <em>MonitorObject</em> into the repository where it will be accessible by the web GUI. It also pushes it to a <em>Printer</em> for the sake of this tutorial.</p>
<p>To run it simply do: </p><pre class="fragment">o2-qc-run-basic
</pre><p>Thanks to the Data Processing Layer (DPL, more details later) it is a single process that steers all the <em>devices</em>, i.e. processes making up the workflow. A window should appear that shows a graphical representation of the workflow if you are running locally. If you are running remotely via ssh, the DPL Debug GUI will not open. In some cases, it then requires to run with <code>-b</code>. The output of any of the processes is available by double clicking a box. If a box is red it means that the process has stopped, probably abnormally.</p>
<p>This is not the GUI we will use to see the histograms.</p>
<div class="image">
<img src="images/basic-dpl-gui.png"  alt="basic-dpl-gui"/>
</div>
<p>The example above consists of one DPL workflow which has both the main processing and the QC infrastructure declared inside. In the real case, we would usually prefer to attach the QC without modifying the original topology. It can be done by merging two (or more) workflows, as shown below: </p><pre class="fragment">o2-qc-run-producer | o2-qc --config json://${QUALITYCONTROL_ROOT}/etc/basic.json
</pre><div class="image">
<img src="images/basic-schema-2-exe.png"  alt="basic-schema-2-exe"/>
</div>
<p>This command uses two executables. The first one contains only the _Producer (see Figure above), which represents the data flow to which we want to apply the QC. The second executable generates the QC infrastructure based on the given configuration file (more details in a few sections). These two workflows are joined together using the pipe <code>|</code> character. This example illustrates how to add QC to any DPL workflow by using <code>o2-qc</code> and passing it a configuration file.</p>
<p><b>Repository and GUI</b></p>
<p>The data is stored in the <a href="ccdb-test.cern.ch:8080/browse">ccdb-test</a> at CERN. If everything works fine you should see the objects being published in the QC web GUI (QCG) at this address: <a href="https://qcg-test.cern.ch/?page=objectTree">https://qcg-test.cern.ch/?page=objectTree</a>. The link brings you to the hierarchy of objects (see screenshot below). Open "qc/TST/MO/QcTask" (the task you are running) and click on "example" which is the name of your histogram.</p>
<div class="image">
<img src="images/basic-qcg1.png"  alt="alt text"/>
</div>
<p><b>Configuration file</b></p>
<p>In the example above, the devices are configured in the config file named <code>basic.json</code>. It is installed in <code>$QUALITYCONTROL_ROOT/etc</code>. Each time you rebuild the code, <code>$QUALITYCONTROL_ROOT/etc/basic.json</code> is overwritten by the file in the source directory (<code>~/alice/QualityControl/Framework/basic.json</code>).</p>
<p>The configuration for the QC is made of many parameters described in an <a href="https://github.com/AliceO2Group/QualityControl/blob/master/doc/Advanced.md#configuration-files-details">advanced section of the documentation</a>. For now we can just see below the definition of a task. <code>moduleName</code> and <code>className</code> specify respectively the library and the class to load and instantiate to do the actual job of the task. </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;(...)</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;&quot;tasks&quot;: {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &quot;QcTask&quot;: {</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    &quot;active&quot;: &quot;true&quot;,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    &quot;className&quot;: &quot;o2::quality_control_modules::skeleton::SkeletonTask&quot;,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    &quot;moduleName&quot;: &quot;QcSkeleton&quot;,</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    &quot;cycleDurationSeconds&quot;: &quot;10&quot;,</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;(...)</div></div><!-- fragment --><p> Try and change the name of the task by replacing <code>QcTask</code> by a name of your choice (there are 2 places to update in the config file!). Relaunch the workflows. You should now see the object published under a different directory in the QCG.</p>
<h3>Readout chain</h3>
<p>In this second example, we are going to use the Readout as our data source.</p>
<div class="image">
<img src="images/readout-schema.png"  alt="alt text"/>
</div>
<p>This workflow is a bit different from the basic one. The <em>Readout</em> is not a DPL, nor a FairMQ, device and thus we have to have a <em>proxy</em> to get data from it. This is the extra box going to the <em>Data Sampling</em>, which then injects data to the task. This is handled in the <em>Readout</em> as long as you enable the corresponding configuration flag.</p>
<p>The first thing is to load the environment for the readout in a new terminal: <code>alienv enter Readout/latest</code>.</p>
<p>Then enable the data sampling channel in readout by opening the readout config file located at <code>$READOUT_ROOT/etc/readout-qc.cfg</code> and make sure that the following properties are correct:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# Enable the data sampling</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[consumer-fmq-qc]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;consumerType=FairMQChannel</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;enableRawFormat=1</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;fmq-name=readout-qc</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;fmq-address=ipc:///tmp/readout-pipe-1</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;fmq-type=pub</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;fmq-transport=zeromq</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;unmanagedMemorySize=2G</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;memoryPoolNumberOfPages=500</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;memoryPoolPageSize=1M</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;enabled=1</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;(...)</div></div><!-- fragment --><p>Start Readout in a terminal: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;readout.exe file://$READOUT_ROOT/etc/readout-qc.cfg</div></div><!-- fragment --><p>Start in another terminal the proxy, DataSampling and QC workflows: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-qc-run-readout | o2-qc --config json://${QUALITYCONTROL_ROOT}/etc/readout.json</div></div><!-- fragment --><p>The data sampling is configured to sample 1% of the data as the readout should run by default at full speed.</p>
<h4>Getting real data from readout</h4>
<p>See <a href="doc/ModulesDevelopment.md#readout">these instructions for readout</a> and <a href="doc/ModulesDevelopment.md#dpl-workflow">these for O2 utilities</a>.</p>
<h4>Readout data format as received by the Task</h4>
<p>The header is an O2 header populated with data from the header built by the Readout. The payload received is a 2MB (configurable) data page made of CRU pages (8kB).</p>
<p><b>Configuration file</b></p>
<p>The configuration file is installed in <code>$QUALITYCONTROL_ROOT/etc</code>. Each time you rebuild the code, <code>$QUALITYCONTROL_ROOT/etc/readout.json</code> is overwritten by the file in the source directory (<code>~/alice/QualityControl/Framework/readout.json</code>). To avoid this behaviour and preserve the changes you do to the configuration, you can copy the file and specify the path to it with the parameter <code>--config</code> when launch <code>o2-qc</code>.</p>
<p>To change the fraction of the data being monitored, change the option <code>fraction</code>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&quot;fraction&quot;: &quot;0.01&quot;,</div></div><!-- fragment --> <hr/>
<h3>Post-processing example</h3>
<p>Now we will run an additional application performing further processing of data generated by the basic workflow. Run it again in one terminal window:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-qc-run-basic</div></div><!-- fragment --><p>In another terminal window run the ExampleTrend post-processing task, as follows:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;o2-qc-run-postprocessing --config json://${QUALITYCONTROL_ROOT}/etc/postprocessing.json --name ExampleTrend --period 10</div></div><!-- fragment --><p>On the <a href="https://qcg-test.cern.ch/?page=objectTree">QCG website</a> you will see a TTree and additional plots visible under the path <code>/qc/TST/MO/ExampleTrend</code>. They show how different properties of the Example histogram change during time. The longer the applications are running, the more data will be visible.</p>
<p>The post-processing framework and its convenience classes allow to trend and correlate various characteristics of histograms and other data structures generated by QC tasks and checks. One can create their own post-processing tasks or use the ones included in the framework and configure them for one's own needs.</p>
<p>../README.md "↑ Go to the Table of Content ↑" | Continue to Modules Development → </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
